<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro automático de eventos</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f4;
  padding: 20px;
}

textarea {
  width: 100%;
  height: 180px;
  padding: 10px;
  font-size: 14px;
}

button {
  margin-top: 10px;
  padding: 10px 20px;
  cursor: pointer;
}

table {
  margin-top: 20px;
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
}

td {
  min-width: 90px;
}

td[contenteditable="true"] {
  background: #fdfdfd;
}
</style>
</head>

<body>

<h2>Registro automático de eventos</h2>

<textarea id="mensaje" placeholder="Pega aquí el mensaje del evento"></textarea>
<br>
<button onclick="procesarMensaje()">Procesar mensaje</button>

<table id="tabla">
<thead>
<tr>
<th>Contratante</th>
<th>Recreadora</th>
<th>Dirección</th>
<th>Barrio</th>
<th>Hora</th>
<th>Teléfono</th>
<th>Costo</th>
<th>Gasto</th>
<th>Ganancia</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const recreadoras = ["juliana", "valentina", "angélica", "angelica", "vanessa"];

function procesarMensaje() {
  const texto = document.getElementById("mensaje").value.toLowerCase();

  let contratante = "";
  let recreadora = "";
  let direccion = "";
  let barrio = "";
  let hora = "";
  let telefonos = [];
  let costo = 0;
  let gasto = 0;

  // NOMBRE CONTRATANTE
  const nombreMatch = texto.match(/nombre contratante[:\s]*([a-záéíóúñ\s]+)/i);
  if (nombreMatch) {
    contratante = nombreMatch[1].trim();
  } else {
    const palabras = texto.split(/\s+/);
    contratante = palabras.slice(0, 2).join(" ");
  }

  // RECREADORA
  recreadoras.forEach(r => {
    if (texto.includes(r)) recreadora = r.charAt(0).toUpperCase() + r.slice(1);
  });

  // DIRECCIÓN
  const dirMatch = texto.match(/(cra|carrera|cll|cl|calle|av|avenida)[^,\n]+/i);
  if (dirMatch) direccion = dirMatch[0];

  // BARRIO
  const barrioMatch = texto.match(/b\/?\s*([a-záéíóúñ\s]+)/i);
  if (barrioMatch) barrio = barrioMatch[1];

  // HORA
  const horaMatch = texto.match(/\d{1,2}(:\d{2})?\s?(am|pm)/i);
  if (horaMatch) hora = horaMatch[0];

  // TELÉFONOS
  telefonos = texto.match(/3\d{9}/g) || [];

  // COSTO
  const costoMatch = texto.match(/\$?\s*(\d{2,3})(\.000|000| mil)?/i);
  if (costoMatch) {
    costo = parseInt(costoMatch[1]) * 1000;
  }

  // GASTO
  if (recreadora === "Vanessa") gasto = 20000;
  if (["Juliana", "Valentina", "Angélica", "Angelica"].includes(recreadora)) gasto = 70000;

  const ganancia = costo - gasto;

  agregarFila([
    contratante,
    recreadora,
    direccion,
    barrio,
    hora,
    telefonos.join(" / "),
    costo.toLocaleString(),
    gasto.toLocaleString(),
    ganancia.toLocaleString()
  ]);

  document.getElementById("mensaje").value = "";
  guardarDatos();
}

function agregarFila(datos) {
  const tbody = document.querySelector("#tabla tbody");
  const tr = document.createElement("tr");

  datos.forEach(d => {
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.innerText = d;
    tr.appendChild(td);
  });

  tbody.appendChild(tr);
}

// ===== PERSISTENCIA =====
function guardarDatos() {
  const filas = document.querySelectorAll("#tabla tbody tr");
  const datos = [];

  filas.forEach(fila => {
    const filaDatos = [];
    fila.querySelectorAll("td").forEach(td => {
      filaDatos.push(td.innerText);
    });
    datos.push(filaDatos);
  });

  localStorage.setItem("eventos", JSON.stringify(datos));
}

function cargarDatos() {
  const datos = JSON.parse(localStorage.getItem("eventos"));
  if (!datos) return;

  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";

  datos.forEach(fila => {
    const tr = document.createElement("tr");
    fila.forEach(texto => {
      const td = document.createElement("td");
      td.contentEditable = "true";
      td.innerText = texto;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

window.addEventListener("load", cargarDatos);
document.querySelector("#tabla").addEventListener("input", guardarDatos);
</script>

</body>
</html>