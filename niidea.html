<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro automático de eventos</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f4;
    padding: 20px;
}
textarea {
    width: 100%;
    height: 190px;
    padding: 10px;
}
button {
    margin-top: 10px;
    padding: 10px 20px;
    cursor: pointer;
}
table {
    margin-top: 20px;
    width: 100%;
    border-collapse: collapse;
    background: #fff;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
}
th {
    background: #2c3e50;
    color: #fff;
}
td[contenteditable="true"] {
    background: #fafafa;
}
</style>
</head>

<body>

<h2>Registro automático de eventos</h2>

<textarea data-input="mensaje" placeholder="Pega aquí el mensaje del evento"></textarea>
<br>
<button data-action="procesar">Procesar mensaje</button>

<table>
<thead>
<tr>
    <th>Contratante</th>
    <th>Recreadora</th>
    <th>Dirección</th>
    <th>Barrio</th>
    <th>Hora</th>
    <th>Teléfono</th>
    <th>Costo</th>
    <th>Gasto</th>
    <th>Ganancia</th>
</tr>
</thead>
<tbody data-tabla="eventos"></tbody>
</table>

<script>
/* =======================
   ESTADO CENTRAL
======================= */
let estadoEvento = {
    contratante: "",
    recreadora: "",
    direccion: "",
    barrio: "",
    hora: "",
    telefonos: [],
    costo: 0,
    gasto: 0,
    ganancia: 0
};

/* =======================
   CONFIGURACIÓN
======================= */
const recreadoras = ["juliana", "valentina", "angelica", "angélica", "vanessa"];
const gastos = {
    juliana: 70000,
    valentina: 70000,
    angelica: 70000,
    angélica: 70000,
    vanessa: 20000
};

/* =======================
   UTILIDADES
======================= */
function normalizar(txt) {
    return txt.toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
}

function normalizarCosto(txt) {
    if (txt.toLowerCase().includes("mil")) {
        return parseInt(txt.replace(/\D/g, "")) * 1000;
    }
    return parseInt(txt.replace(/\D/g, ""));
}

/* =======================
   EXTRACCIÓN
======================= */
function extraerContratante(texto) {
    let m = texto.match(/nombre\s+contratante[:*]?\s*([A-ZÁÉÍÓÚÑ][a-záéíóúñ]+(?:\s[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+)?)/i);
    if (m) return m[1].trim();

    const prohibidas = ["nombre","contratante","evento","direccion","dirección","costo","valor","hora","telefono","teléfono"];
    const candidatos = texto.match(/[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+(?:\s[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+)?/g) || [];

    for (let n of candidatos) {
        if (!prohibidas.includes(n.toLowerCase().replace(/[*:]/g,""))) {
            return n;
        }
    }
    return "";
}

function extraerHora(texto) {
    let m = texto.match(/(\d{1,2})(:\d{2})?\s*(am|pm)/i);
    if (m) {
        return `${m[1].padStart(2,"0")}${m[2] || ":00"} ${m[3].toLowerCase()}`;
    }
    return "";
}

function extraerCosto(texto) {
    let m = texto.match(/\$\s?\d{1,3}(\.\d{3})+|\$\s?\d+\s?mil|\$\s?\d+/i);
    if (m) return normalizarCosto(m[0]);

    const nums = texto.match(/\d+\s?mil|\d{3,6}/gi) || [];
    let max = 0;
    nums.forEach(n => {
        const v = normalizarCosto(n);
        if (v > max) max = v;
    });
    return max;
}

/* =======================
   PROCESADOR PRINCIPAL
======================= */
function procesarTexto(texto) {
    const t = normalizar(texto);

    estadoEvento.contratante = extraerContratante(texto);
    estadoEvento.hora = extraerHora(texto);
    estadoEvento.costo = extraerCosto(texto);
    estadoEvento.telefonos = texto.match(/3\d{9}/g) || [];

    let recreadora = "";
    recreadoras.forEach(r => {
        if (t.includes(normalizar(r))) recreadora = r;
    });
    estadoEvento.recreadora = recreadora;
    estadoEvento.gasto = gastos[normalizar(recreadora)] || 0;
    estadoEvento.ganancia = estadoEvento.costo - estadoEvento.gasto;

    const d = texto.match(/(cra|cr|carrera|cl|cll|calle|av|avenida)[^,\n]+/i);
    estadoEvento.direccion = d ? d[0] : "";

    const b = texto.match(/b\/\s*([a-záéíóúñ\s]+)/i);
    estadoEvento.barrio = b ? b[1] : "";
}

/* =======================
   RENDER
======================= */
function pintarFila() {
    const tabla = document.querySelector("[data-tabla='eventos']");
    tabla.insertAdjacentHTML("beforeend", `
        <tr>
            <td contenteditable="true">${estadoEvento.contratante}</td>
            <td contenteditable="true">${estadoEvento.recreadora}</td>
            <td contenteditable="true">${estadoEvento.direccion}</td>
            <td contenteditable="true">${estadoEvento.barrio}</td>
            <td contenteditable="true">${estadoEvento.hora}</td>
            <td contenteditable="true">${estadoEvento.telefonos.join(" / ")}</td>
            <td contenteditable="true">${estadoEvento.costo.toLocaleString()}</td>
            <td contenteditable="true">${estadoEvento.gasto.toLocaleString()}</td>
            <td contenteditable="true">${estadoEvento.ganancia.toLocaleString()}</td>
        </tr>
    `);
}

/* =======================
   EVENTOS (DOM MINIMAL)
======================= */
document.addEventListener("click", e => {
    if (e.target.dataset.action === "procesar") {
        const texto = document.querySelector("[data-input='mensaje']").value;
        procesarTexto(texto);
        pintarFila();
        document.querySelector("[data-input='mensaje']").value = "";
    }
});
</script>

</body>
</html>